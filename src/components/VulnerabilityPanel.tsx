"use client";

import { useState, useEffect, useCallback } from "react";
import { StatusIndicator } from "./StatusIndicator";

// Types
interface Vulnerability {
  id: string;
  cveId: string;
  summary: string;
  cvss: number | null;
  cvssVector: string | null;
  cwe: string | null;
  references: { url: string; source: string }[];
  publishedDate: string;
  lastModified: string;
  affectedProducts: string[];
  severity: "critical" | "high" | "medium" | "low" | "unknown";
}

interface VulnerabilityStats {
  total: number;
  critical: number;
  high: number;
  medium: number;
  low: number;
  last24h: number;
}

interface VulnerabilityApiResponse {
  vulnerabilities: Vulnerability[];
  stats: VulnerabilityStats;
  lastUpdated: string;
  error?: string;
}

// Severity badge
interface SeverityBadgeProps {
  severity: Vulnerability["severity"];
  cvss: number | null;
}

function SeverityBadge({ severity, cvss }: SeverityBadgeProps) {
  const severityConfig: Record<
    string,
    { bg: string; text: string; label: string }
  > = {
    critical: { bg: "bg-critical/15", text: "text-critical", label: "CRIT" },
    high: { bg: "bg-alert/15", text: "text-alert", label: "HIGH" },
    medium: { bg: "bg-info/15", text: "text-info", label: "MED" },
    low: {
      bg: "bg-status-active/15",
      text: "text-status-active",
      label: "LOW",
    },
    unknown: { bg: "bg-text-muted/15", text: "text-text-muted", label: "N/A" },
  };

  const config = severityConfig[severity] || severityConfig.unknown;

  return (
    <div className="flex items-center gap-1">
      <span
        className={`inline-flex items-center px-1.5 py-0.5 text-[9px] font-semibold tracking-widest uppercase ${config.bg} ${config.text}`}
      >
        {config.label}
      </span>
      {cvss != null && (
        <span className={`text-[10px] font-mono font-semibold ${config.text}`}>
          {cvss.toFixed(1)}
        </span>
      )}
    </div>
  );
}

// Format time ago
function formatTimeAgo(timestamp: string): string {
  const now = new Date();
  const then = new Date(timestamp);
  const diffMs = now.getTime() - then.getTime();
  const diffMins = Math.floor(diffMs / 60000);

  if (diffMins < 1) return "NOW";
  if (diffMins < 60) return `${diffMins}M`;
  const diffHours = Math.floor(diffMins / 60);
  if (diffHours < 24) return `${diffHours}H`;
  const diffDays = Math.floor(diffHours / 24);
  return `${diffDays}D`;
}

// Vulnerability row
interface VulnerabilityRowProps {
  vuln: Vulnerability;
  isExpanded?: boolean;
  onClick?: () => void;
}

function VulnerabilityRow({
  vuln,
  isExpanded,
  onClick,
}: VulnerabilityRowProps) {
  const handleReferenceClick = (e: React.MouseEvent, url: string) => {
    e.stopPropagation();
    window.open(url, "_blank", "noopener,noreferrer");
  };

  return (
    <div
      className={`
        group cursor-pointer border-b border-divider last:border-b-0
        transition-colors duration-150
        ${isExpanded ? "bg-base-700" : "hover:bg-base-750"}
        ${vuln.severity === "critical" ? "border-l-2 border-l-critical" : ""}
      `}
      onClick={onClick}
    >
      {/* Main row */}
      <div className="flex items-center gap-2 px-3 py-2">
        {/* Severity indicator */}
        <div className="flex-shrink-0 w-4">
          <StatusIndicator
            status={
              vuln.severity === "critical"
                ? "critical"
                : vuln.severity === "high"
                  ? "alert"
                  : vuln.severity === "medium"
                    ? "info"
                    : "active"
            }
            size="sm"
            pulse={vuln.severity === "critical" || vuln.severity === "high"}
          />
        </div>

        {/* CVE ID */}
        <div className="flex-shrink-0 w-28">
          <span className="text-xs font-mono font-semibold text-cyber-cyan">
            {vuln.cveId}
          </span>
        </div>

        {/* Severity badge */}
        <div className="flex-shrink-0 w-16">
          <SeverityBadge severity={vuln.severity} cvss={vuln.cvss} />
        </div>

        {/* Summary */}
        <div className="flex-1 min-w-0">
          <span className="text-xs text-text-primary truncate block">
            {vuln.summary.substring(0, 80)}
            {vuln.summary.length > 80 ? "..." : ""}
          </span>
        </div>

        {/* Time */}
        <div className="flex-shrink-0 w-10 text-right">
          <span className="text-xxs font-mono text-text-muted tabular-nums">
            {formatTimeAgo(vuln.publishedDate)}
          </span>
        </div>

        {/* Expand indicator */}
        <div className="flex-shrink-0 w-4">
          <span className="text-xxs text-text-muted">
            {isExpanded ? "▼" : "▶"}
          </span>
        </div>
      </div>

      {/* Expanded details */}
      {isExpanded && (
        <div className="px-3 pb-2 animate-fade-in">
          <div className="pl-6 border-l-2 border-divider ml-1.5 space-y-2">
            {/* Full summary */}
            <p className="text-xxs text-text-secondary">{vuln.summary}</p>

            {/* CVSS Vector */}
            {vuln.cvssVector && (
              <div className="flex items-center gap-2">
                <span className="text-[9px] font-mono text-text-muted uppercase">
                  CVSS:
                </span>
                <code className="text-[10px] font-mono text-cyber-cyan bg-base-700 px-1.5 py-0.5">
                  {vuln.cvssVector}
                </code>
              </div>
            )}

            {/* CWE */}
            {vuln.cwe && (
              <div className="flex items-center gap-2">
                <span className="text-[9px] font-mono text-text-muted uppercase">
                  CWE:
                </span>
                <span className="text-[10px] font-mono text-info">
                  {vuln.cwe}
                </span>
              </div>
            )}

            {/* Affected Products */}
            {vuln.affectedProducts.length > 0 && (
              <div className="flex flex-wrap gap-1">
                <span className="text-[9px] font-mono text-text-muted uppercase mr-1">
                  AFFECTED:
                </span>
                {vuln.affectedProducts.slice(0, 4).map((prod, i) => (
                  <span
                    key={i}
                    className="text-[8px] font-mono text-alert bg-alert/10 px-1.5 py-0.5"
                  >
                    {prod.substring(0, 20)}
                  </span>
                ))}
                {vuln.affectedProducts.length > 4 && (
                  <span className="text-[8px] font-mono text-text-muted">
                    +{vuln.affectedProducts.length - 4} more
                  </span>
                )}
              </div>
            )}

            {/* References */}
            {vuln.references.length > 0 && (
              <div className="flex flex-wrap gap-1">
                <span className="text-[9px] font-mono text-text-muted uppercase mr-1">
                  REFS:
                </span>
                {vuln.references.slice(0, 3).map((ref, i) => (
                  <button
                    key={i}
                    onClick={(e) => handleReferenceClick(e, ref.url)}
                    className="text-[8px] font-mono text-info hover:text-cyber-cyan bg-base-700 hover:bg-base-600 px-1.5 py-0.5 transition-colors"
                  >
                    {ref.source || "LINK"} ↗
                  </button>
                ))}
                {vuln.references.length > 3 && (
                  <span className="text-[8px] font-mono text-text-muted">
                    +{vuln.references.length - 3} more
                  </span>
                )}
              </div>
            )}
          </div>
        </div>
      )}
    </div>
  );
}

// Stats bar
interface StatsBarProps {
  stats: VulnerabilityStats;
}

function StatsBar({ stats }: StatsBarProps) {
  return (
    <div className="flex items-center gap-4 px-3 py-2 border-b border-divider bg-base-800">
      <div className="flex items-center gap-2">
        <span className="text-[9px] font-mono text-text-muted uppercase">
          24H:
        </span>
        <span className="text-xs font-mono text-text-primary tabular-nums">
          {stats.last24h}
        </span>
      </div>

      <div className="w-px h-3 bg-divider" />

      <div className="flex items-center gap-2">
        <span className="text-[9px] font-mono text-text-muted uppercase">
          CRIT:
        </span>
        <span
          className={`text-xs font-mono tabular-nums ${stats.critical > 0 ? "text-critical" : "text-text-primary"}`}
        >
          {stats.critical}
        </span>
      </div>

      <div className="w-px h-3 bg-divider" />

      <div className="flex items-center gap-2">
        <span className="text-[9px] font-mono text-text-muted uppercase">
          HIGH:
        </span>
        <span
          className={`text-xs font-mono tabular-nums ${stats.high > 0 ? "text-alert" : "text-text-primary"}`}
        >
          {stats.high}
        </span>
      </div>

      <div className="w-px h-3 bg-divider" />

      <div className="flex items-center gap-2">
        <span className="text-[9px] font-mono text-text-muted uppercase">
          MED:
        </span>
        <span className="text-xs font-mono text-info tabular-nums">
          {stats.medium}
        </span>
      </div>

      <div className="w-px h-3 bg-divider" />

      <div className="flex items-center gap-2">
        <span className="text-[9px] font-mono text-text-muted uppercase">
          LOW:
        </span>
        <span className="text-xs font-mono text-status-active tabular-nums">
          {stats.low}
        </span>
      </div>
    </div>
  );
}

// Filter controls
interface FilterControlsProps {
  activeSeverity: string;
  onSeverityChange: (severity: string) => void;
}

function FilterControls({
  activeSeverity,
  onSeverityChange,
}: FilterControlsProps) {
  const severities = ["all", "critical", "high", "medium", "low"];

  return (
    <div className="flex items-center gap-4 px-3 py-2 border-b border-divider bg-base-800">
      <div className="flex items-center gap-1">
        <span className="text-xxs font-mono text-text-muted uppercase tracking-wider mr-2">
          SEV:
        </span>
        {severities.map((sev) => (
          <button
            key={sev}
            onClick={() => onSeverityChange(sev)}
            className={`
              px-2 py-0.5 text-[9px] font-semibold tracking-wider uppercase
              transition-all duration-150 ease-linear
              ${
                activeSeverity === sev
                  ? sev === "critical"
                    ? "bg-critical/20 text-critical border border-critical/30"
                    : sev === "high"
                      ? "bg-alert/20 text-alert border border-alert/30"
                      : "bg-info/20 text-info border border-info/30"
                  : "text-text-muted hover:text-text-secondary hover:bg-base-700 border border-transparent"
              }
            `}
          >
            {sev === "all" ? "ALL" : sev.slice(0, 4).toUpperCase()}
          </button>
        ))}
      </div>
    </div>
  );
}

// Loading skeleton
function VulnerabilitySkeleton() {
  return (
    <div className="space-y-0">
      {[...Array(6)].map((_, i) => (
        <div
          key={i}
          className="flex items-center gap-2 px-3 py-2 border-b border-divider animate-pulse"
        >
          <div className="w-4 h-2 bg-base-600 rounded" />
          <div className="w-28 h-4 bg-base-600 rounded" />
          <div className="w-16 h-4 bg-base-600 rounded" />
          <div className="flex-1 h-4 bg-base-600 rounded" />
          <div className="w-10 h-3 bg-base-600 rounded" />
        </div>
      ))}
    </div>
  );
}

// Mock data for fallback
function generateMockVulnerabilities(): Vulnerability[] {
  const mockData: Vulnerability[] = [
    {
      id: "1",
      cveId: "CVE-2024-0001",
      summary:
        "Critical remote code execution vulnerability in popular web framework allows unauthenticated attackers to execute arbitrary code",
      cvss: 9.8,
      cvssVector: "CVSS:3.1/AV:N/AC:L/PR:N/UI:N/S:U/C:H/I:H/A:H",
      cwe: "CWE-94",
      references: [
        {
          url: "https://nvd.nist.gov/vuln/detail/CVE-2024-0001",
          source: "NVD",
        },
      ],
      publishedDate: new Date(Date.now() - 2 * 60 * 60 * 1000).toISOString(),
      lastModified: new Date().toISOString(),
      affectedProducts: ["Framework v1.0", "Framework v1.1", "Framework v1.2"],
      severity: "critical",
    },
    {
      id: "2",
      cveId: "CVE-2024-0002",
      summary:
        "SQL injection vulnerability in authentication module allows privilege escalation",
      cvss: 8.1,
      cvssVector: "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:N",
      cwe: "CWE-89",
      references: [
        {
          url: "https://nvd.nist.gov/vuln/detail/CVE-2024-0002",
          source: "NVD",
        },
      ],
      publishedDate: new Date(Date.now() - 5 * 60 * 60 * 1000).toISOString(),
      lastModified: new Date().toISOString(),
      affectedProducts: ["Auth Module v2.0"],
      severity: "high",
    },
    {
      id: "3",
      cveId: "CVE-2024-0003",
      summary: "Cross-site scripting (XSS) vulnerability in user profile page",
      cvss: 6.1,
      cvssVector: "CVSS:3.1/AV:N/AC:L/PR:N/UI:R/S:C/C:L/I:L/A:N",
      cwe: "CWE-79",
      references: [
        {
          url: "https://nvd.nist.gov/vuln/detail/CVE-2024-0003",
          source: "NVD",
        },
      ],
      publishedDate: new Date(Date.now() - 12 * 60 * 60 * 1000).toISOString(),
      lastModified: new Date().toISOString(),
      affectedProducts: ["WebApp v3.0"],
      severity: "medium",
    },
    {
      id: "4",
      cveId: "CVE-2024-0004",
      summary: "Information disclosure through verbose error messages",
      cvss: 4.3,
      cvssVector: "CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:L/I:N/A:N",
      cwe: "CWE-209",
      references: [
        {
          url: "https://nvd.nist.gov/vuln/detail/CVE-2024-0004",
          source: "NVD",
        },
      ],
      publishedDate: new Date(Date.now() - 24 * 60 * 60 * 1000).toISOString(),
      lastModified: new Date().toISOString(),
      affectedProducts: ["API Gateway v1.5"],
      severity: "medium",
    },
    {
      id: "5",
      cveId: "CVE-2024-0005",
      summary: "Denial of service through malformed input handling",
      cvss: 3.7,
      cvssVector: "CVSS:3.1/AV:N/AC:H/PR:N/UI:N/S:U/C:N/I:N/A:L",
      cwe: "CWE-400",
      references: [
        {
          url: "https://nvd.nist.gov/vuln/detail/CVE-2024-0005",
          source: "NVD",
        },
      ],
      publishedDate: new Date(Date.now() - 48 * 60 * 60 * 1000).toISOString(),
      lastModified: new Date().toISOString(),
      affectedProducts: ["Parser Library v2.1"],
      severity: "low",
    },
  ];
  return mockData;
}

// Main component
interface VulnerabilityPanelProps {
  maxItems?: number;
  showFilters?: boolean;
  showStats?: boolean;
  useLiveData?: boolean;
}

export default function VulnerabilityPanel({
  maxItems = 15,
  showFilters = true,
  showStats = true,
  useLiveData = true,
}: VulnerabilityPanelProps) {
  const [vulnerabilities, setVulnerabilities] = useState<Vulnerability[]>([]);
  const [stats, setStats] = useState<VulnerabilityStats>({
    total: 0,
    critical: 0,
    high: 0,
    medium: 0,
    low: 0,
    last24h: 0,
  });
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState<string | null>(null);
  const [lastUpdated, setLastUpdated] = useState<Date>(new Date());
  const [expandedId, setExpandedId] = useState<string | null>(null);
  const [activeSeverity, setActiveSeverity] = useState("all");

  const fetchData = useCallback(async () => {
    try {
      setError(null);

      if (!useLiveData) {
        // Use mock data
        const mockVulns = generateMockVulnerabilities();
        setVulnerabilities(mockVulns);
        setStats({
          total: mockVulns.length,
          critical: mockVulns.filter((v) => v.severity === "critical").length,
          high: mockVulns.filter((v) => v.severity === "high").length,
          medium: mockVulns.filter((v) => v.severity === "medium").length,
          low: mockVulns.filter((v) => v.severity === "low").length,
          last24h: mockVulns.filter(
            (v) =>
              new Date(v.publishedDate).getTime() >
              Date.now() - 24 * 60 * 60 * 1000,
          ).length,
        });
        setLastUpdated(new Date());
        setIsLoading(false);
        return;
      }

      const response = await fetch("/api/vulnerabilities");

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}`);
      }

      const data: VulnerabilityApiResponse = await response.json();
      setVulnerabilities(data.vulnerabilities || []);
      setStats(data.stats || stats);
      setLastUpdated(new Date(data.lastUpdated));

      if (data.error) {
        setError(data.error);
      }
    } catch (err) {
      console.error("Vulnerability fetch error:", err);
      // Fall back to mock data on error
      const mockVulns = generateMockVulnerabilities();
      setVulnerabilities(mockVulns);
      setStats({
        total: mockVulns.length,
        critical: mockVulns.filter((v) => v.severity === "critical").length,
        high: mockVulns.filter((v) => v.severity === "high").length,
        medium: mockVulns.filter((v) => v.severity === "medium").length,
        low: mockVulns.filter((v) => v.severity === "low").length,
        last24h: mockVulns.filter(
          (v) =>
            new Date(v.publishedDate).getTime() >
            Date.now() - 24 * 60 * 60 * 1000,
        ).length,
      });
      setError("Using cached data");
    } finally {
      setIsLoading(false);
    }
  }, [useLiveData]);

  useEffect(() => {
    fetchData();
  }, [fetchData]);

  // Auto-refresh every 5 minutes
  useEffect(() => {
    if (!useLiveData) return;

    const interval = setInterval(fetchData, 5 * 60 * 1000);
    return () => clearInterval(interval);
  }, [fetchData, useLiveData]);

  // Filter vulnerabilities
  const filteredVulns = vulnerabilities
    .filter((v) => activeSeverity === "all" || v.severity === activeSeverity)
    .slice(0, maxItems);

  const lastUpdateStr = lastUpdated.toISOString().substring(11, 19) + "Z";

  const overallStatus = error
    ? "alert"
    : isLoading
      ? "info"
      : stats.critical > 0
        ? "critical"
        : stats.high > 0
          ? "alert"
          : "active";

  return (
    <div className="panel h-full flex flex-col">
      {/* Header */}
      <div className="panel-header">
        <div className="flex items-center gap-3">
          <span className="panel-title">⚠️ VULNERABILITY FEED</span>
          <div className="flex items-center gap-1.5">
            <StatusIndicator
              status={overallStatus as "active" | "alert" | "critical" | "info"}
              size="sm"
              pulse={isLoading || stats.critical > 0}
            />
            <span
              className={`text-xxs font-mono uppercase tracking-wider ${
                error
                  ? "text-alert"
                  : isLoading
                    ? "text-info"
                    : stats.critical > 0
                      ? "text-critical"
                      : "text-status-active"
              }`}
            >
              {error
                ? "CACHED"
                : isLoading
                  ? "LOADING"
                  : stats.critical > 0
                    ? `${stats.critical} CRITICAL`
                    : "MONITORING"}
            </span>
          </div>
        </div>

        <div className="flex items-center gap-2">
          <span className="text-xxs font-mono text-text-muted tabular-nums">
            {lastUpdateStr}
          </span>
          {useLiveData && (
            <button
              onClick={() => fetchData()}
              disabled={isLoading}
              className="text-xxs font-mono text-text-muted hover:text-info uppercase tracking-wider disabled:opacity-50 transition-colors"
            >
              ↻
            </button>
          )}
        </div>
      </div>

      {/* Filters */}
      {showFilters && (
        <FilterControls
          activeSeverity={activeSeverity}
          onSeverityChange={setActiveSeverity}
        />
      )}

      {/* Stats */}
      {showStats && !isLoading && stats.total > 0 && <StatsBar stats={stats} />}

      {/* Vulnerability list */}
      <div className="flex-1 overflow-y-auto">
        {isLoading && vulnerabilities.length === 0 ? (
          <VulnerabilitySkeleton />
        ) : filteredVulns.length === 0 ? (
          <div className="flex items-center justify-center h-full">
            <span className="text-xs font-mono text-text-muted uppercase tracking-wider">
              NO VULNERABILITIES MATCH FILTER
            </span>
          </div>
        ) : (
          filteredVulns.map((vuln) => (
            <VulnerabilityRow
              key={vuln.id}
              vuln={vuln}
              isExpanded={expandedId === vuln.id}
              onClick={() =>
                setExpandedId(expandedId === vuln.id ? null : vuln.id)
              }
            />
          ))
        )}
      </div>

      {/* Footer */}
      <div className="px-3 py-1.5 border-t border-divider bg-base-800 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <div
            className={`w-1.5 h-1.5 rounded-full ${
              error
                ? "bg-alert"
                : isLoading
                  ? "bg-info animate-ping"
                  : "bg-status-active animate-breathe"
            }`}
          />
          <span className="text-xxs font-mono text-text-muted uppercase tracking-wider">
            {useLiveData ? "NVD / CVE" : "MOCK DATA"}
          </span>
        </div>
        <span className="text-xxs font-mono text-text-muted tabular-nums">
          {filteredVulns.length} / {stats.total} CVEs
        </span>
      </div>
    </div>
  );
}

// Compact variant
export function CompactVulnerabilityPanel() {
  return (
    <VulnerabilityPanel maxItems={8} showFilters={false} showStats={false} />
  );
}
